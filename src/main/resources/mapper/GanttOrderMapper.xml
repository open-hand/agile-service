<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.choerodon.agile.infra.mapper.GanttOrderMapper">
    <insert id="batchInsert">
        <bind name="audit" value="@io.choerodon.mybatis.helper.AuditHelper@audit()"/>
        insert into agile_gantt_order (issue_id, dimension, instance_id, instance_type, rank, project_id, organization_id, created_by, last_updated_by)
        values
        <foreach collection="ganttOrders" item="ganttOrder" separator=",">
            (
            #{ganttOrder.issueId},
            #{ganttOrder.dimension},
            #{ganttOrder.instanceId},
            #{ganttOrder.instanceType},
            #{ganttOrder.rank},
            #{ganttOrder.projectId},
            #{ganttOrder.organizationId},
            #{audit.user},
            #{audit.user}
            )
        </foreach>
    </insert>


    <select id="selectByOptions" resultType="io.choerodon.agile.infra.dto.GanttOrderDTO">
        select ago.*
        from agile_gantt_order ago
        where ago.organization_id = #{organizationId}
        and ago.project_id = #{projectId}
        and ago.dimension = #{dimension}
        and ago.instance_type = #{instanceType}
        and ago.instance_id = #{instanceId}
        <if test="issueIds != null and issueIds.size() > 0">
            and ago.issue_id in
            <foreach collection="issueIds" item="issueId" open="(" close=")" separator=",">
                #{issueId}
            </foreach>
        </if>
    </select>

    <select id="selectMinRank" resultType="io.choerodon.agile.infra.dto.GanttOrderDTO">
        select rank
        from agile_gantt_order
        where organization_id = #{organizationId}
        and project_id = #{projectId}
        and dimension = #{dimension}
        and instance_type = #{instanceType}
        and instance_id = #{instanceId}
        order by rank asc
        limit 1
    </select>

    <select id="selectByIssueIdWithRank" resultType="io.choerodon.agile.infra.dto.GanttOrderDTO">
        select
        ai.issue_id,
        ago.rank,
        ago.id
        from agile_issue ai
        left join agile_gantt_order ago
        on (
        ago.organization_id = #{organizationId}
        and ago.project_id = #{projectId}
        and ago.dimension = #{dimension}
        and ago.instance_type = #{instanceType}
        and ago.instance_id = #{instanceId}
        and ai.issue_id = ago.issue_id
        )
        where ai.project_id = #{projectId}
        and ai.issue_id in
        <foreach collection="issueIds" item="issueId" open="(" close=")" separator=",">
            #{issueId}
        </foreach>
    </select>

    <select id="selectMaxPreviousRankOrderByRankAsc" resultType="java.lang.String">
        select rank
        from agile_gantt_order
        where organization_id = #{organizationId}
        and project_id = #{projectId}
        and dimension = #{dimension}
        and instance_type = #{instanceType}
        and instance_id = #{instanceId}
        and rank &lt; #{rank}
        order by rank desc
        limit 1
    </select>
</mapper>